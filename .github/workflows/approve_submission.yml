name: Approve and Publish Custom Label Set

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  approve-and-publish:
    if: >
      !github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'automated-review') && contains(github.event.issue.labels.*.name, 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Permission
        env:
          ACTOR: ${{ github.actor }}
          OWNER: ${{ github.repository_owner }}
        run: |
          if [ "$ACTOR" != "$OWNER" ]; then
            echo "❌ Permission denied."
            exit 1
          fi

      - name: Parse Issue Body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: python3 .github/scripts/parse_issue.py

      - name: Download File
        run: |
          curl -L -o submission.txt "${{ env.FILE_URL }}"

      - name: Run Profanity Check
        id: profanity
        run: |
          # Run the user's custom script
          # It prints "FLAGGED_LINES_START" if issues are found
          OUTPUT=$(python3 .github/scripts/filters/check_content.py submission.txt)
          
          if echo "$OUTPUT" | grep -q "FLAGGED_LINES_START"; then
            echo "⚠️ Profanity found!"
            echo "::error::Profanity check failed."
            
            # Save output to a file to use in the comment
            echo "$OUTPUT" > flags.txt
            echo "has_flags=true" >> $GITHUB_OUTPUT
          else
            echo "✅ Content looks clean."
            echo "has_flags=false" >> $GITHUB_OUTPUT
          fi

      - name: Halt on Profanity
        if: steps.profanity.outputs.has_flags == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read the flags and format a comment
          # We extract lines between START and END
          FLAGS=$(sed -n '/FLAGGED_LINES_START/,/FLAGGED_LINES_END/p' flags.txt | sed '1d;$d')
          
          COMMENT="⚠️ **Publication Halted: Content Warning**
          
          Your custom script flagged the following lines:
          
          | Line | Word | Context |
          |---|---|---|
          $(echo "$FLAGS" | awk -F'|' '{print "| "$1" | "$2" | "$3" |"}')
          
          Please review the file manually."
          
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          exit 1

      - name: Publish to Repository
        # Only runs if previous steps succeeded
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p community_sets
          
          SAFE_NAME=$(echo "${{ env.SET_NAME }}" | tr -dc '[:alnum:]_-')
          TARGET="community_sets/${{ github.event.issue.user.login }}_${SAFE_NAME}.txt"
          
          mv submission.txt "$TARGET"
          
          # Update README
          TABLE="community_sets/README.md"
          [ ! -f "$TABLE" ] && echo "| Creator | Set | Language | Progress | Notes | Date | Link |" > "$TABLE" && echo "|---|---|---|---|---|---|---|" >> "$TABLE"
          
          DATE=$(date +%Y-%m-%d)
          echo "| ${{ github.event.issue.user.login }} | ${{ env.SET_NAME }} | ${{ env.LANGUAGE }} | ${{ env.PROGRESS }} | ${{ env.NOTES }} | $DATE | [Download]($TARGET) |" >> "$TABLE"
          
          git config user.name "github-actions[bot]"
          git config user.email "bot@users.noreply.github.com"
          git add community_sets/
          git commit -m "Add set: ${{ env.SET_NAME }}"
          git push

          gh issue comment ${{ github.event.issue.number }} --body "✅ **Published!**"
          gh issue close ${{ github.event.issue.number }} --reason "completed"