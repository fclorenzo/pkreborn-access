name: Approve and Publish Custom Label Set

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  approve-and-publish:
    if: >
      !github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'automated-review') && contains (github.event.issue.labels.*.name, 'custom-names')
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout MAIN (to get the Python scripts)
      - name: Checkout Code (Scripts)
        uses: actions/checkout@v4
        with:
          path: main_code

      # 2. Checkout DATA Branch (to get the files)
      - name: Checkout Data (Community Sets)
        uses: actions/checkout@v4
        with:
          ref: community-sets
          path: community_data
          fetch-depth: 0

      - name: Verify Permission
        env:
          ACTOR: ${{ github.actor }}
          OWNER: ${{ github.repository_owner }}
        run: |
          if [ "$ACTOR" != "$OWNER" ]; then
            echo "❌ Permission denied."
            exit 1
          fi

      - name: Parse Issue Body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        # Run script from main_code, output env vars globally
        run: python3 main_code/.github/scripts/parse_issue.py

      - name: Download File
        # Download to root workspace temporarily
        run: curl -L -o submission.txt "${{ env.FILE_URL }}"

      - name: Run Profanity Check
        id: profanity
        run: |
          OUTPUT=$(python3 main_code/.github/scripts/filters/check_content.py submission.txt)
          
          if echo "$OUTPUT" | grep -q "FLAGGED_LINES_START"; then
            echo "$OUTPUT" > flags.txt
            echo "has_flags=true" >> $GITHUB_OUTPUT
          else
            echo "has_flags=false" >> $GITHUB_OUTPUT
          fi

      - name: Halt on Profanity
        if: steps.profanity.outputs.has_flags == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FLAGS=$(sed -n '/FLAGGED_LINES_START/,/FLAGGED_LINES_END/p' flags.txt | sed '1d;$d')
          COMMENT="⚠️ **Publication Halted: Content Warning**
          
          Your custom script flagged the following lines:
          
          | Line | Word | Context |
          |---|---|---|
          $(echo "$FLAGS" | awk -F'|' '{print "| "$1" | "$2" | "$3" |"}')
          
          Please review the file manually."
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          exit 1

      - name: Calculate Version and Path
        id: calc_version
        env:
          USER: ${{ github.event.issue.user.login }}
          SET_NAME: ${{ env.SET_NAME }}
          REQ_VERSION: ${{ env.VERSION }}
        run: |
          # IMPORTANT: Switch to community_data directory so the script scans the correct branch
          cd community_data
          python3 ../main_code/.github/scripts/calc_version.py

      - name: Publish to Data Branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Move work to the data folder
          cd community_data
          
          # 1. Create Folder (FINAL_FOLDER is relative, e.g., "community_sets/user/set_v1")
          mkdir -p "${{ env.FINAL_FOLDER }}"
          
          # 2. Move file from workspace root (../submission.txt) to target
          mv ../submission.txt "${{ env.FINAL_FOLDER }}/pra-custom-names.txt"
          
          # 3. Update Table
          TABLE="community_sets/README.md"
          # (Table header check removed as we assume it exists on the branch now)
          
          # Generate Link (Absolute Link for robustness across branches)
          DATE=$(date +%Y-%m-%d)
          RAW_LINK="https://github.com/${{ github.repository }}/blob/community-sets/${{ env.FINAL_FOLDER }}/pra-custom-names.txt"
          
          CLEAN_NOTES=$(echo "${{ env.NOTES }}" | tr -d '\n\r')
          
          echo "| ${{ github.event.issue.user.login }} | ${{ env.SET_NAME }} | v${{ env.FINAL_VERSION }} | ${{ env.LANGUAGE }} | ${{ env.PROGRESS }} | $CLEAN_NOTES | $DATE | [Download]($RAW_LINK) |" >> "$TABLE"
          
          # 4. Commit and Push to community-sets
          git config user.name "github-actions[bot]"
          git config user.email "bot@users.noreply.github.com"
          git add community_sets/
          git commit -m "Add set: ${{ env.SET_NAME }} v${{ env.FINAL_VERSION }}"
          git push origin community-sets

          # 5. Close Issue
          gh issue comment ${{ github.event.issue.number }} --body "✅ **Published!**
          - **Set:** ${{ env.SET_NAME }}
          - **Version:** v${{ env.FINAL_VERSION }}
          - **Link:** [View File]($RAW_LINK)"
          
          gh issue close ${{ github.event.issue.number }} --reason "completed"