name: Approve and Publish Custom Label Set

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  approve-and-publish:
    if: >
      !github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'automated-review') && contains (github.event.issue.labels.*.name, 'custom-names')
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout MAIN (to get the Python scripts)
      - name: Checkout Code (Scripts)
        uses: actions/checkout@v4
        with:
          path: main_code

      # 2. Checkout DATA Branch (to get the files)
      - name: Checkout Data (Community Sets)
        uses: actions/checkout@v4
        with:
          ref: community-sets
          path: community_data
          fetch-depth: 0

      - name: Verify Permission
        env:
          ACTOR: ${{ github.actor }}
          OWNER: ${{ github.repository_owner }}
        run: |
          if [ "$ACTOR" != "$OWNER" ]; then
            echo "❌ Permission denied. Only the repo owner ($OWNER) can approve."
            exit 1
          fi

      - name: Parse Issue Body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        # Run script from main_code
        run: python3 main_code/.github/scripts/parse_issue.py

      - name: Calculate Version and Path
        id: calc_version
        env:
          USER: ${{ github.event.issue.user.login }}
          SET_NAME: ${{ env.SET_NAME }}
          REQ_VERSION: ${{ env.VERSION }}
        run: |
          # Switch to community_data so the script scans the data branch
          cd community_data
          # Call the script located in main_code
          python3 ../main_code/.github/scripts/calc_version.py

      - name: Publish to Data Branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CREATOR: ${{ github.event.issue.user.login }}
          SET_NAME: ${{ env.SET_NAME }}
          LANGUAGE: ${{ env.LANGUAGE }}
          PROGRESS: ${{ env.PROGRESS }}
          NOTES: ${{ env.NOTES }}
          FINAL_VERSION: ${{ env.FINAL_VERSION }}
          FINAL_FOLDER: ${{ env.FINAL_FOLDER }}
          FILE_URL: ${{ env.FILE_URL }}
        run: |
          # Move work to the data folder
          cd community_data
          
          # 1. Create Folder
          mkdir -p "${{ env.FINAL_FOLDER }}"
          
          # 2. Download File directly to target
          curl -L -o "${{ env.FINAL_FOLDER }}/pra-custom-names.txt" "${{ env.FILE_URL }}"
          
          # 3. Update Table (Using External Script)
          # We call the script from the 'main_code' directory
          python3 ../main_code/.github/scripts/update_table.py
          
          # 4. Commit and Push to community-sets
          git config user.name "github-actions[bot]"
          git config user.email "bot@users.noreply.github.com"
          git add community_sets/
          git commit -m "Add set: ${{ env.SET_NAME }} v${{ env.FINAL_VERSION }}"
          git push origin community-sets

          # 5. Close Issue
          gh issue comment ${{ github.event.issue.number }} --body "✅ **Published!**
          - **Set:** ${{ env.SET_NAME }}
          - **Version:** v${{ env.FINAL_VERSION }}
          - Check it out in the [community sets libbrary](https://github.com/fclorenzo/pkreborn-access/blob/community-sets/community_sets/README.md)."

          gh issue close ${{ github.event.issue.number }} --reason "completed"