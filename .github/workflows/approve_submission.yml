name: Approve and Publish Custom Label Set

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  approve-and-publish:
    if: >
      !github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'automated-review') && contains (github.event.issue.labels.*.name, 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Permission
        env:
          ACTOR: ${{ github.actor }}
          OWNER: ${{ github.repository_owner }}
        run: |
          if [ "$ACTOR" != "$OWNER" ]; then
            echo "❌ Permission denied."
            exit 1
          fi

      - name: Parse Issue Body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: python3 .github/scripts/parse_issue.py

      - name: Calculate Version and Path
        id: calc_version
        env:
          USER: ${{ github.event.issue.user.login }}
          SET_NAME: ${{ env.SET_NAME }}
          REQ_VERSION: ${{ env.VERSION }}
        run: python3 .github/scripts/calc_version.py

      - name: Download and Publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the final folder
          mkdir -p "${{ env.FINAL_FOLDER }}"
          
          # Download directly to the target path
          curl -L -o "${{ env.FINAL_FOLDER }}/pra-custom-names.txt" "${{ env.FILE_URL }}"
          
          # Update Table
          TABLE="community_sets/README.md"
          [ ! -f "$TABLE" ] && echo "| Creator | Set | Version | Language | Progress | Notes | Date | Link |" > "$TABLE" && echo "|---|---|---|---|---|---|---|---|" >> "$TABLE"
          
          DATE=$(date +%Y-%m-%d)
          LINK="[Download](${{ env.FINAL_FOLDER }}/pra-custom-names.txt)"
          
          # Clean notes for the table row
          CLEAN_NOTES=$(echo "${{ env.NOTES }}" | tr -d '\n\r')
          
          # Append row
          echo "| ${{ github.event.issue.user.login }} | ${{ env.SET_NAME }} | v${{ env.FINAL_VERSION }} | ${{ env.LANGUAGE }} | ${{ env.PROGRESS }} | $CLEAN_NOTES | $DATE | $LINK |" >> "$TABLE"
          
          # Git Commit
          git config user.name "github-actions[bot]"
          git config user.email "bot@users.noreply.github.com"
          git add community_sets/
          git commit -m "Add set: ${{ env.SET_NAME }} v${{ env.FINAL_VERSION }}"
          git push

          gh issue comment ${{ github.event.issue.number }} --body "✅ **Published!**
          - **Set:** ${{ env.SET_NAME }}
          - **Version:** v${{ env.FINAL_VERSION }}
          
          gh issue close ${{ github.event.issue.number }} --reason "completed"