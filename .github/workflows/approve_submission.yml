name: Approve and Publish Custom Label Set

on:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: write

jobs:
  approve-and-publish:
    if: >
      contains(github.event.issue.labels.*.name, 'custom-names') &&
      contains(github.event.issue.labels.*.name, 'automated-review') &&
      startsWith(toLower(github.event.comment.body || ''), 'approve')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Issue Form Data
        id: parse
        uses: peter-murray/issue-body-parser-action@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          issue_id: ${{ github.event.issue.number }}
          fail_on_missing: true

      - name: Prepare Metadata
        id: meta
        run: |
          echo "SET_NAME=$(echo '${{ steps.parse.outputs.payload }}' | jq -r '.\"Label Set Name\"')" >> $GITHUB_ENV
          echo "LANGUAGE=$(echo '${{ steps.parse.outputs.payload }}' | jq -r '.Language')" >> $GITHUB_ENV
          echo "PROGRESS=$(echo '${{ steps.parse.outputs.payload }}' | jq -r '.\"Game Progress\"')" >> $GITHUB_ENV
          echo "NOTES=$(echo '${{ steps.parse.outputs.payload }}' | jq -r '.\"Creator\'s Notes\"')" >> $GITHUB_ENV
          echo "FILE_FIELD=$(echo '${{ steps.parse.outputs.payload }}' | jq -r '.\"Upload File\"')" >> $GITHUB_ENV
          echo "CREATOR=${{ github.event.issue.user.login }}" >> $GITHUB_ENV
          echo "DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV

      - name: Extract File URL
        id: extract_url
        run: |
          match=$(echo "${FILE_FIELD}" | grep -oP '\((https?://[^\)]+)\)')
          if [ -z "$match" ]; then
            echo "No file URL found in issue body."
            exit 1
          fi
          FILE_URL=$(echo $match | sed 's/[()]//g')
          echo "FILE_URL=$FILE_URL" >> $GITHUB_ENV
          echo "Found file URL: $FILE_URL"

      - name: Scan for Offensive or Inappropriate Language
        id: content_check
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          FILE_URL: ${{ env.FILE_URL }}
        run: |
          # --- Inline Python scanner ---
          cat << 'EOF' > scan_badwords.py
          import os
          import re
          import sys
          import urllib.request

          issue_number = os.environ["ISSUE_NUMBER"]

          def gh_comment(msg):
              os.system(f'gh issue comment {issue_number} --body "{msg}"')

          def gh_label(label):
              os.system(f'gh issue edit {issue_number} --add-label \"{label}\"")

          BAD_WORDS = {
              "fuck","shit","bitch","asshole","dick","cock","pussy","cunt",
              "faggot","nigger","nigga","slut","whore","rape","rapist",
              "penis","vagina","boob","boobs","cum","jizz","wank",
              "masturbate","suck","blowjob","buttfuck","anal","anus",
              "porn","sex","sexual"
          }

          SAFE_WORDS = {
              "sharpedo","cofagrigus","lickitung","skuntank","clamperl",
              "cockatoo","assassin","grass","classic","passion",
              "scunthorpe","hell","dam","medusa","nightshade"
          }

          file_url = os.environ.get("FILE_URL", "").strip()
          if not file_url:
              gh_comment("âš ï¸ Could not find file URL to scan.")
              sys.exit(0)

          try:
              with urllib.request.urlopen(file_url) as response:
                  content = response.read().decode("utf-8", errors="ignore")
          except Exception as e:
              gh_comment(f"âš ï¸ Could not download file for bad-word scanning: {e}")
              sys.exit(0)

          lowered = content.lower()
          for safe in SAFE_WORDS:
              lowered = lowered.replace(safe, "")

          found = []
          for bad in BAD_WORDS:
              if re.search(rf"\\b{re.escape(bad)}\\b", lowered):
                  found.append(bad)

          if found:
              wordlist = ", ".join(sorted(set(found)))
              msg = f"ðŸš¨ **Potentially Inappropriate Content Detected** ðŸš¨\\n\\nThe following terms were found and may need review:\\n\\n- {wordlist}\\n\\nA maintainer should review this submission manually."
              gh_comment(msg)
              gh_label("review-required")
              sys.exit(1)

          print("âœ… No inappropriate terms found.")
          EOF

          python3 scan_badwords.py

      - name: Stop if Review Required
        if: steps.content_check.outcome == 'failure'
        run: |
          echo "Bad words detected â€” halting before publishing."
          exit 1

      - name: Save or Update Custom Label Set
        if: success()  # Only run if the bad-word scan passed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CREATOR: ${{ env.CREATOR }}
          SET_NAME: ${{ env.SET_NAME }}
          LANGUAGE: ${{ env.LANGUAGE }}
          PROGRESS: ${{ env.PROGRESS }}
          NOTES: ${{ env.NOTES }}
          DATE: ${{ env.DATE }}
          FILE_URL: ${{ env.FILE_URL }}
        run: |
          mkdir -p community_sets
          SAFE_NAME=$(echo "$SET_NAME" | tr -dc '[:alnum:]_-')
          TARGET_FILE="community_sets/${CREATOR}_${SAFE_NAME}.txt"

          echo "Downloading $FILE_URL..."
          curl -L -o "$TARGET_FILE" "$FILE_URL"

          echo "Renaming file to pra-custom-names.txt..."
          mv "$TARGET_FILE" "community_sets/${CREATOR}_${SAFE_NAME}_pra-custom-names.txt"
          TARGET_FILE="community_sets/${CREATOR}_${SAFE_NAME}_pra-custom-names.txt"

          echo "âœ… File saved at $TARGET_FILE"

          TABLE_FILE="community_sets/README.md"
          mkdir -p community_sets
          if [ ! -f "$TABLE_FILE" ]; then
            echo "| Creator | Set Name | Language | Progress | Notes | Date | File |" > "$TABLE_FILE"
            echo "|----------|-----------|-----------|-----------|--------|------|------|" >> "$TABLE_FILE"
          fi

          grep -q "| $CREATOR | $SET_NAME |" "$TABLE_FILE" && UPDATED="yes" || UPDATED="no"

          if [ "$UPDATED" = "yes" ]; then
            sed -i "/| $CREATOR | $SET_NAME |/c| $CREATOR | $SET_NAME | $LANGUAGE | $PROGRESS | ${NOTES//|/-} | $DATE | [Download]($TARGET_FILE) |" "$TABLE_FILE"
            gh issue comment ${{ github.event.issue.number }} --body "âœ… **Existing set updated:** $SET_NAME by @$CREATOR"
          else
            echo "| $CREATOR | $SET_NAME | $LANGUAGE | $PROGRESS | ${NOTES//|/-} | $DATE | [Download]($TARGET_FILE) |" >> "$TABLE_FILE"
            gh issue comment ${{ github.event.issue.number }} --body "âœ… **New set published:** $SET_NAME by @$CREATOR"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add community_sets/
          git commit -m "Publish/update custom label set: $SET_NAME by $CREATOR"
          git push
