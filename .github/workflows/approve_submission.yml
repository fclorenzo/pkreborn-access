name: Approve & Publish Label Set

on:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: read

jobs:
  approve-and-publish:
    if: >
      contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Latest Closing Comment
        id: get_comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT=$(gh issue view ${{ github.event.issue.number }} --json comments --jq '.comments | last(.[]).body')
          echo "COMMENT<<EOF" >> $GITHUB_ENV
          echo "$COMMENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Check if Approved
        id: approval_check
        run: |
          echo "Checking approval status..."
          if echo "${COMMENT,,}" | grep -q '^approve'; then
            echo "APPROVED=true" >> $GITHUB_ENV
          else
            echo "APPROVED=false" >> $GITHUB_ENV
          fi

      - name: Stop if Not Approved
        if: env.APPROVED != 'true'
        run: |
          echo "‚ùå Issue was closed without approval keyword. Exiting."
          exit 0

      - name: Parse Issue Form
        id: parse
        uses: peter-murray/issue-body-parser-action@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          issue_id: ${{ github.event.issue.number }}
          separator: '###'
          label_marker_start: '>>'
          label_marker_end: '<<'

      - name: Download and Process Submission
        id: process
        env:
          PAYLOAD: ${{ steps.parse.outputs.payload }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          import os, json, re, urllib.request, pathlib, datetime

          payload = json.loads(os.environ['PAYLOAD'])
          set_name = payload.get('Label Set Name', 'Unnamed_Set').strip().replace(' ', '_')
          language = payload.get('Language', 'English').strip().replace(' ', '_')
          progress = payload.get('Game Progress', '')
          notes = payload.get("Creator's Notes", '')
          file_field = payload.get('Upload File', '')
          actor = os.environ.get('GITHUB_ACTOR', 'unknown')

          # Parse file URL
          match = re.search(r'\[(.*?)\]\((.*?)\)', file_field)
          if not match:
              raise SystemExit("‚ùå Could not extract uploaded file link.")
          file_url = match.group(2)

          base_dir = pathlib.Path('community-label-sets') / language / set_name
          meta_path = base_dir / 'metadata.json'
          target_path = base_dir / 'pra-custom-names.txt'

          is_update = False
          # --- Detect if update or needs unique suffix
          if meta_path.exists():
              try:
                  old_meta = json.load(open(meta_path))
                  old_creator = old_meta.get('creator', '').lower()
                  if old_creator == actor.lower():
                      is_update = True
                      print(f"Detected update by same creator: {actor}")
                  else:
                      print(f"Existing set with different creator ({old_creator}). Creating separate folder.")
                      set_name = f"{set_name}_by_{actor}"
                      base_dir = pathlib.Path('community-label-sets') / language / set_name
                      base_dir.mkdir(parents=True, exist_ok=True)
                      meta_path = base_dir / 'metadata.json'
                      target_path = base_dir / 'pra-custom-names.txt'
              except Exception as e:
                  print(f"Error reading old metadata: {e}")

          base_dir.mkdir(parents=True, exist_ok=True)

          # --- Download and save file ---
          print(f"Downloading file from: {file_url}")
          with urllib.request.urlopen(file_url) as response:
              content = response.read().decode('utf-8')
          with open(target_path, 'w', encoding='utf-8') as f:
              f.write(content)
          print(f"File saved to: {target_path}")

          # --- Update metadata ---
          meta = {
              "creator": actor,
              "date": datetime.datetime.utcnow().strftime('%Y-%m-%d'),
              "progress": progress,
              "notes": notes,
              "update": is_update
          }
          with open(meta_path, 'w', encoding='utf-8') as mf:
              json.dump(meta, mf, indent=2)

          # --- Export environment ---
          with open(os.environ['GITHUB_ENV'], 'a') as envfile:
              envfile.write(f"SET_NAME={set_name}\n")
              envfile.write(f"LANGUAGE={language}\n")
              envfile.write(f"IS_UPDATE={'true' if is_update else 'false'}\n")

      - name: Update Community Index
        run: |
          INDEX="COMMUNITY_SETS.md"
          SET_PATH="community-label-sets/${LANGUAGE}/${SET_NAME}"
          LINK="[$SET_NAME]($SET_PATH/pra-custom-names.txt)"
          DATE=$(date -u +"%Y-%m-%d")
          STATUS=$( [ "${IS_UPDATE}" = "true" ] && echo "Updated" || echo "New" )

          if [ ! -f "$INDEX" ]; then
            echo "| Label Set | Language | Last Modified | Status |" > "$INDEX"
            echo "|------------|-----------|---------------|---------|" >> "$INDEX"
          fi

          grep -v "| $SET_NAME |" "$INDEX" > "$INDEX.tmp" || true
          mv "$INDEX.tmp" "$INDEX"

          echo "| $LINK | $LANGUAGE | $DATE | $STATUS |" >> "$INDEX"

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add community-label-sets/ COMMUNITY_SETS.md
          git commit -m "Publish ${IS_UPDATE:+updated }community label set: ${SET_NAME} (${LANGUAGE})" || echo "No changes to commit"
          git push

      - name: Comment Summary on Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${IS_UPDATE}" = "true" ]; then
            MSG="üîÅ **Update Published!**
            Your existing label set **${SET_NAME}** in **${LANGUAGE}** has been updated successfully.  
            üìÇ [View it here](community-label-sets/${LANGUAGE}/${SET_NAME}/pra-custom-names.txt)"
          else
            MSG="‚úÖ **New Label Set Published!**
            Your label set **${SET_NAME}** in **${LANGUAGE}** has been added to the community collection.  
            üìÇ [View it here](community-label-sets/${LANGUAGE}/${SET_NAME}/pra-custom-names.txt)"
          fi

          gh issue comment ${{ github.event.issue.number }} --body "$MSG"
