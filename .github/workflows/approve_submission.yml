name: Approve and Publish Custom Label Set

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  approve-and-publish:
    if: >
      !github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/approve') &&
      contains(github.event.issue.labels.*.name, 'automated-review') && contains (github.event.issue.labels.*.name, 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to check existing files/versions

      - name: Verify Permission
        env:
          ACTOR: ${{ github.actor }}
          OWNER: ${{ github.repository_owner }}
        run: |
          if [ "$ACTOR" != "$OWNER" ]; then
            echo "❌ Permission denied."
            exit 1
          fi

      - name: Parse Issue Body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: python3 .github/scripts/parse_issue.py

      - name: Download File
        run: curl -L -o submission.txt "${{ env.FILE_URL }}"

      - name: Run Profanity Check
        id: profanity
        run: |
          OUTPUT=$(python3 .github/scripts/filters/check_content.py submission.txt)
          
          if echo "$OUTPUT" | grep -q "FLAGGED_LINES_START"; then
            echo "$OUTPUT" > flags.txt
            echo "has_flags=true" >> $GITHUB_OUTPUT
          else
            echo "has_flags=false" >> $GITHUB_OUTPUT
          fi

      - name: Halt on Profanity
        if: steps.profanity.outputs.has_flags == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FLAGS=$(sed -n '/FLAGGED_LINES_START/,/FLAGGED_LINES_END/p' flags.txt | sed '1d;$d')
          COMMENT="⚠️ **Publication Halted: Content Warning**
          
          The following lines were flagged:
          
          | Line | Word | Context |
          |---|---|---|
          $(echo "$FLAGS" | awk -F'|' '{print "| "$1" | "$2" | "$3" |"}')
          
          Please review the file manually."
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          exit 1

      - name: Calculate Version and Path
        id: calc_version
        env:
          USER: ${{ github.event.issue.user.login }}
          SET_NAME: ${{ env.SET_NAME }}
          REQ_VERSION: ${{ env.VERSION }}
        run: python3 .github/scripts/calc_version.py

      - name: Publish to Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p "${{ env.FINAL_FOLDER }}"
          mv submission.txt "${{ env.FINAL_FOLDER }}/pra-custom-names.txt"
          
          # Update Table
          TABLE="community_sets/README.md"
          [ ! -f "$TABLE" ] && echo "| Creator | Set | Version | Language | Progress | Notes | Date | Link |" > "$TABLE" && echo "|---|---|---|---|---|---|---|---|" >> "$TABLE"
          
          DATE=$(date +%Y-%m-%d)
          LINK="[Download](${{ env.FINAL_FOLDER }}/pra-custom-names.txt)"
          
          # Append row
          echo "| ${{ github.event.issue.user.login }} | ${{ env.SET_NAME }} | v${{ env.FINAL_VERSION }} | ${{ env.LANGUAGE }} | ${{ env.PROGRESS }} | ${{ env.NOTES }} | $DATE | $LINK |" >> "$TABLE"
          
          # Git Commit
          git config user.name "github-actions[bot]"
          git config user.email "bot@users.noreply.github.com"
          git add community_sets/
          git commit -m "Add set: ${{ env.SET_NAME }} v${{ env.FINAL_VERSION }}"
          git push

          gh issue comment ${{ github.event.issue.number }} --body "✅ **Published!**
          - **Set:** ${{ env.SET_NAME }}
          - **Version:** v${{ env.FINAL_VERSION }}
          - **Path:** \`${{ env.FINAL_FOLDER }}/pra-custom-names.txt\`"
          
          gh issue close ${{ github.event.issue.number }} --reason "completed"