name: Triage Label Submission

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  triage-submission:
    # Only run if the issue has both review-related labels
    if: contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'automated-review') || contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Parse Issue Form Data
        id: parse
        uses: peter-murray/issue-body-parser-action@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          issue_id: ${{ github.event.issue.number }}
          fail_on_missing: true

      - name: Validate File and Structure
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          JSON_PAYLOAD: ${{ steps.parse.outputs.payload }}
        run: |
          # --- Write Python validation script ---
          cat << 'EOF' > validate_script.py
          import os
          import json
          import re
          import sys
          import urllib.request

          def gh_comment_and_fail(msg):
              """Comment on issue, label as validation-failed, and exit."""
              issue = os.environ["ISSUE_NUMBER"]
              os.system(f'gh issue comment {issue} --body "{msg}"')
              os.system(f'gh issue edit {issue} --add-label "validation-failed" || true')
              os.system(f'gh issue edit {issue} --add-label "automated-review" || true')
              sys.exit(1)

          try:
              payload = json.loads(os.environ['JSON_PAYLOAD'])
              file_field = payload.get('Upload File', '')

              match = re.search(r'\[(.*?)\]\((.*?)\)', file_field)
              if not match:
                  gh_comment_and_fail('‚ùå **Submission Failed**\n\nNo valid file attachment found in the "Upload File" section.')

              filename = match.group(1)
              file_url = match.group(2)
              print(f'Found file: {filename}')

              target_name = 'pra-custom-names.txt'
              if filename != target_name:
                  print(f'Filename mismatch. Will rename {filename} ‚Üí {target_name} later.')

              try:
                  with urllib.request.urlopen(file_url) as response:
                      content = response.read().decode('utf-8')
              except Exception as e:
                  gh_comment_and_fail(f'‚ùå **Download Error**\n\nCould not download the file. Error: {str(e)}')

              lines = content.splitlines()
              valid_entries = 0
              errors = []

              for i, line in enumerate(lines):
                  line = line.strip()
                  if not line or line.startswith('#'):
                      continue

                  parts = line.split(';')
                  if len(parts) < 6:
                      errors.append(f'Line {i+1}: Found {len(parts)} columns (Expected 6+).')
                      if len(errors) > 3:
                          break
                      continue

                  if not (parts[0].isdigit() and parts[2].isdigit() and parts[3].isdigit()):
                      errors.append(f'Line {i+1}: Map ID, X, or Y are not numbers.')
                      if len(errors) > 3:
                          break
                      continue

                  valid_entries += 1

              if errors:
                  error_msg = '\n- '.join(errors)
                  gh_comment_and_fail(f'‚ùå **Validation Failed**\n\n**Errors Found:**\n- {error_msg}')

              if valid_entries == 0:
                  gh_comment_and_fail('‚ùå **Validation Failed**\n\nFile appears empty or contains no valid data lines.')

              print('‚úÖ Validation Passed.')
              issue = os.environ["ISSUE_NUMBER"]
              os.system(f'gh issue edit {issue} --remove-label "validation-failed" || true')
              os.system(f'gh issue edit {issue} --add-label "automated-review" || true')

              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f'FILE_URL={file_url}\n')
                  f.write(f'ORIGINAL_NAME={filename}\n')
                  f.write(f'VALID_ENTRIES={valid_entries}\n')

          except Exception as e:
              gh_comment_and_fail(f'‚ùå **System Error**\n\n{str(e)}')
          EOF

          # --- Run the script ---
          python3 validate_script.py

      - name: Assign and Comment
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          URL: ${{ env.FILE_URL }}
          ENTRIES: ${{ env.VALID_ENTRIES }}
          NAME: ${{ env.ORIGINAL_NAME }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-assignee ${{ github.repository_owner }}

          MSG="ü§ñ **Beep Boop!**
          
          I have successfully validated your submission.
          - **File Status:** ‚úÖ Valid Structure
          - **Original Name:** \`$NAME\` (I will auto-rename this to \`pra-custom-names.txt\`)
          - **Entries Found:** $ENTRIES
          - **Download URL:** [Link]($URL)
          
          I have assigned this to @${{ github.repository_owner }} for final approval."

          gh issue comment ${{ github.event.issue.number }} --body "$MSG"
