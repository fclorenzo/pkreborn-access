name: Triage Label Submission

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write

jobs:
  triage-submission:
    if: contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'automated-review')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Authenticate GH CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Parse and Validate Submission
        id: validate
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat << 'EOF' > validate_script.py
          import os, re, sys, urllib.request

          def comment(msg):
              os.system(f'gh issue comment {os.environ["ISSUE_NUMBER"]} --body "{msg}"')

          def fail(msg):
              comment(msg)
              os.system(f'gh issue close {os.environ["ISSUE_NUMBER"]} --reason "not planned"')
              sys.exit(1)

          body = os.environ["ISSUE_BODY"]

          match = re.search(r'\[(.*?)\]\((https://.*?)\)', body)
          if not match:
              fail("❌ Could not find a valid file link in the submission form.")
          filename, url = match.groups()

          print(f"Found file {filename}: {url}")
          try:
              with urllib.request.urlopen(url) as r:
                  content = r.read().decode("utf-8")
          except Exception as e:
              fail(f"❌ Download error: {e}")

          lines = content.splitlines()
          valid = 0
          for line in lines:
              if not line or line.startswith("#"): continue
              parts = line.split(";")
              if len(parts) < 5: continue
              if not parts[0].isdigit(): continue
              valid += 1

          if valid == 0:
              fail("❌ File appears empty or invalid.")

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"FILE_URL={url}\n")
              f.write(f"ORIGINAL_NAME={filename}\n")
              f.write(f"VALID_ENTRIES={valid}\n")

          comment(f"✅ File validated: {valid} valid lines found. Awaiting maintainer review.")
          EOF

          python3 validate_script.py

      - name: Assign Maintainer
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-assignee ${{ github.repository_owner }}
