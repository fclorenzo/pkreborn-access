name: Triage Label Submission

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write

jobs:
  triage-submission:
    if: >
      contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'automated-review')
      && contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Authenticate GH CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Parse and Validate Submission
        id: validate
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat << 'EOF' > validate_script.py
          import os, re, sys, urllib.request

          def comment(msg):
              os.system(f'gh issue comment {os.environ["ISSUE_NUMBER"]} --body "{msg}"')

          def fail(msg):
              comment(msg)
              os.system(f'gh issue close {os.environ["ISSUE_NUMBER"]} --reason "not planned"')
              sys.exit(1)

          body = os.environ["ISSUE_BODY"]

          match = re.search(r'\[(.*?)\]\((https://.*?)\)', body)
          if not match:
              fail("‚ùå Could not find a valid file link in the submission form.")
          filename, url = match.groups()

          print(f"Found file {filename}: {url}")
          try:
              with urllib.request.urlopen(url) as r:
                  content = r.read().decode("utf-8")
          except Exception as e:
              fail(f"‚ùå Download error: {e}")

          lines = content.splitlines()
          valid = 0
          for line in lines:
              if not line or line.startswith("#"): continue
              parts = line.split(";")
              if len(parts) < 5: continue
              if not parts[0].isdigit(): continue
              valid += 1

          if valid == 0:
              fail("‚ùå File appears empty or invalid.")

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"FILE_URL={url}\n")
              f.write(f"ORIGINAL_NAME={filename}\n")
              f.write(f"VALID_ENTRIES={valid}\n")

          comment(f"‚úÖ File validated: {valid} valid lines found. Awaiting maintainer review.")
          EOF

          python3 validate_script.py

      - name: Offensive Language Scan
        id: badwords
        run: |
          # Download the file for scanning
          curl -L "$FILE_URL" -o submission.txt
          
          python3 .github/scripts/filters/check_content.py submission.txt > scan_output.txt
          
          if grep -q "FLAGGED_LINES_START" scan_output.txt; then
            echo "flags=true" >> $GITHUB_OUTPUT
          else
            echo "flags=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on Offensive Results
        if: steps.badwords.outputs.flags == 'true'
        run: |
          echo "üö® **Potential Offensive Content Detected!**" > msg.txt
          echo "" >> msg.txt
          echo "The following lines may contain problematic language:" >> msg.txt
          echo "" >> msg.txt
          awk -F'|' '/^[0-9]+\|/ { printf "- **Line %s** (word: _%s_): `%s`\n", $1, $2, $3 }' scan_output.txt >> msg.txt
          gh issue comment ${{ github.event.issue.number }} --body-file msg.txt

      - name: Assign Maintainer
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-assignee ${{ github.repository_owner }}
