name: Triage Label Submission

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write
  contents: read

jobs:
  triage-submission:
    if: contains(github.event.issue.labels.*.name, 'automated-review') && contains(github.event.issue.labels.*.name, 'custom-names')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Parse Issue Body
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: python3 .github/scripts/parse_issue.py

      - name: Download File
        run: |
          curl -L -o submission.txt "${{ env.FILE_URL }}"

      - name: Validate Structure
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: python3 .github/scripts/validate_structure.py submission.txt

      - name: Run Profanity Check
        id: profanity
        run: |
          # Run your custom script against the downloaded file
          OUTPUT=$(python3 .github/scripts/filters/check_content.py submission.txt)
          
          # Check if the script flagged anything
          if echo "$OUTPUT" | grep -q "FLAGGED_LINES_START"; then
            echo "has_flags=true" >> $GITHUB_OUTPUT
            # Save the raw output to a file so we can parse it in the next step
            echo "$OUTPUT" > profanity_report.txt
          else
            echo "has_flags=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail on Profanity
        if: steps.profanity.outputs.has_flags == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract the table rows from the python output
          FLAGS=$(sed -n '/FLAGGED_LINES_START/,/FLAGGED_LINES_END/p' profanity_report.txt | sed '1d;$d')
          
          COMMENT="‚ùå **Validation Failed: Content Warning**
          
          Your file contains words that were flagged by our filter. Please verify the context or remove them, open a new issue and upload a new file. If you think this was a mistake, please leave a comment explaining why.
          
          | Line | Word | Context |
          |---|---|---|
          $(echo "$FLAGS" | awk -F'|' '{print "| "$1" | "$2" | "$3" |"}')
          "
          
          # Comment, Label as Failed, Remove Review Label, and Close
          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          gh issue edit ${{ github.event.issue.number }} --add-label "validation-failed" --remove-label "automated-review"
          gh issue close ${{ github.event.issue.number }} --reason "not planned"
          
          # Fail the job
          exit 1

      - name: Success & Assign
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --remove-label "validation-failed" --add-label "automated-review" --add-assignee ${{ github.repository_owner }}
          
          gh issue comment ${{ github.event.issue.number }} --body "ü§ñ **Beep Boop!**
          
          Validation Passed!
          - **File Structure:** ‚úÖ Valid (${{ env.VALID_ENTRIES }} entries)
          - **Content Check:** ‚úÖ Clean
          
          @${{ github.repository_owner }}: Ready for final approval."